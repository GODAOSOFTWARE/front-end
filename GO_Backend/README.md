# GoDAO

`go_dao_vote` - это система голосования для децентрализованных автономных организаций (DAO), реализованная на языке Go. Сервис собран на движке Decimal Dapps, который позволяет использовать готовые алгоритмы и методы для сборки сервисов и приложений. Использование этого движка упростило создание проекта за счет предоставления заранее реализованных функций для работы с блокчейном, управления пользователями, обработки транзакций и других ключевых аспектов.

## Инструкция

### Начало работы

Процесс голосования включает в себя несколько этапов:

1. Пользователь авторизуется через конечную точку `/auth/login`.
2. Пользователь создает голосование через конечную точку `/votes`.
3. Пользователи голосуют за или против предложения через конечную точку `/votes/:id/vote`.
4. Результаты голосования могут быть получены через конечные точки `/get-voting-results-by-wallet` и `/votes/:id/votes`.
5. В случае необходимости, пользователь может вывести средства через конечную точку `/api/v1/withdraw`.
6. Голосование и его результаты сохраняются в базу данных и содержат подтверждение от блокчейна в виде хэша.

## Как считаются голоса

Процесс учета голосов включает в себя несколько этапов:

1. **Определение силы голоса**:
    - Сила голоса каждого пользователя определяется на основе его вклада в систему.
    - Вклад пользователя определяется количеством PRO статусов проекта.
    - Чтобы получить силу голоса равную единице, необходимо иметь одну монету PRO.
    - Линейка статусов предлагает покупку "Пакетов голосов".
    - Сила голоса активируется покупкой статуса с личного кошелька.
    - Данные о кошельке покупателя объединяются с данными о силе голосов (количество монет, вырученных от продажи статусов).
    - Эти данные хранятся и обновляются в таблице `vote_strength` базы данных.

2. **Запрос результатов голосования**:
    - Для получения результатов голосования используется функция `FetchVoteResults`, которая делает запрос к API для получения транзакций по адресу кошелька.
    - URL запроса формируется на основе адреса кошелька и включает лимит и смещение для пагинации.

3. **Обработка транзакций**:
    - Ответ API парсится в структуру `WithdrawOrderResponse`, содержащую список транзакций.
    - Для каждой транзакции определяется сила голоса с использованием функции `repository.GetVoteStrength`.
    - Транзакции классифицируются на валидные и невалидные, а также на голоса "за" и "против".

4. **Вычисление итогов голосования**:
    - Итоговая сила голосов "за" и "против" вычисляется с использованием функции `calculateStrength`.
    - Процент голосов рассчитывается функцией `calculatePercentage`.
    - На основе полученных данных определяется статус голосования и резолюция.

5. **Формирование результатов**:
    - Результаты голосования формируются в структуре `VoteResults`, которая включает общее количество голосов, количество валидных и невалидных транзакций, а также итоговую резолюцию.

## Обзор кода

### Обработчики (Handlers)

- `auth_handler.go`
    - Авторизация пользователей
    - Получение информации о текущем пользователе
    - Проверка JWT токена

- `admin.go`
    - Управление кошельками
    - Определение веса голоса
    - Добавление и удаление кошельков

- `vote_handler.go`
    - Создание голосований
    - Получение голосований
    - Удаление голосований
    - Добавление голосов пользователей
    - Получение результатов голосования

- `withdraw_handler.go`
    - Обработка запросов на снятие средств

### Модели (Models)

- `common.go`
    - Общие структуры данных и переменные, используемые в различных частях приложения

- `vote.go`
    - Структуры данных для голосований, включая информацию о голосовании и пользовательские голоса

### Репозиторий (Repository)

- `db.go`
    - Инициализация и управление базой данных

- `user_repository.go`
    - Управление данными пользователей, включая сохранение и получение информации о пользователях

- `vote_repository.go`
    - Управление данными голосов, включая создание, получение и удаление голосов

### Сервисы (Services)

- `vote_service.go`
    - Логика для общих операций голосования, включая вычисление силы голоса и создание голосов

### Утилиты (Utils)

- `response.go`
    - Вспомогательные функции для работы с HTTP ответами

- `requests.go`
    - Вспомогательные функции для обработки HTTP запросов

### Миграции (Migrations)

- `0001_create_votes_table.up.sql` и `0001_create_votes_table.down.sql`
    - Создание и удаление таблицы голосов

- `0002_create_user_votes_table.up.sql` и `0002_create_user_votes_table.down.sql`
    - Создание и удаление таблицы пользовательских голосов

- `0003_create_vote_strength_table.up.sql` и `0003_create_vote_strength_table.down.sql`
    - Создание и удаление таблицы силы голоса

### Тесты (Tests)

- `auth_handler_test.go`
    - Тестирование обработчика аутентификации

- `vote_handler_test.go`
    - Тестирование обработчика голосований

## OPEN API

После установки и запуска программы на локальном порту развернется Swagger. Документация доступна по адресу: [http://localhost:8080/swagger/](http://localhost:8080/swagger/).

## Эндпоинты

### Авторизация

- **POST /auth/login**
    - Назначение: Авторизация пользователя.
    - Авторизация: Не требуется.
    - Роль: Нет ограничений.
    - Результат: JWT токен для авторизации последующих запросов.

- **GET /auth/me**
    - Назначение: Получение информации о текущем пользователе.
    - Авторизация: Требуется JWT токен.
    - Роль: Нет ограничений.
    - Результат: Информация о текущем пользователе.

### Голосование

- **POST /votes**
    - Назначение: Создание нового голосования.
    - Авторизация: Требуется JWT токен.
    - Роль: Нет ограничений.
    - Результат: Подтверждение создания голосования.

- **GET /votes/:id**
    - Назначение: Получение голосования по ID.
    - Авторизация: Требуется JWT токен.
    - Роль: Нет ограничений.
    - Результат: Детали голосования.

- **DELETE /votes/:id**
    - Назначение: Удаление голосования по ID.
    - Авторизация: Требуется JWT токен.
    - Роль: Нет ограничений.
    - Результат: Подтверждение удаления голосования.

- **POST /votes/:id/vote**
    - Назначение: Добавление голоса пользователя к голосованию.
    - Авторизация: Требуется JWT токен.
    - Роль: Нет ограничений.
    - Результат: Подтверждение добавления голоса.

### Результаты голосований

- **GET /get-voting-results-by-wallet**
    - Назначение: Получение результатов голосования по кошельку.
    - Авторизация: Требуется JWT токен.
    - Роль: Нет ограничений.
    - Результат: Результаты голосования по указанному кошельку.

- **GET /votes/:id/votes**
    - Назначение: Получение всех голосов пользователей для указанного голосования.
    - Авторизация: Требуется JWT токен.
    - Роль: Нет ограничений.
    - Результат: Список голосов пользователей.

### Вывод средств

- **POST /api/v1/withdraw**
    - Назначение: Обработка запроса на снятие средств.
    - Авторизация: Требуется JWT токен.
    - Роль: Нет ограничений.
    - Результат: Подтверждение обработки запроса.

### Управление кошельками

- **POST /wallets**
    - Назначение: Добавление нового кошелька.
    - Авторизация: Требуется JWT токен.
    - Роль: Администратор.
    - Результат: Подтверждение добавления кошелька.

- **DELETE /wallets/:wallet_address**
    - Назначение: Удаление кошелька.
    - Авторизация: Требуется JWT токен.
    - Роль: Администратор.
    - Результат: Подтверждение удаления кошелька.

### Работа с таблицами

- **GET /tables**
    - Назначение: Получение списка всех таблиц.
    - Авторизация: Требуется JWT токен.
    - Роль: Администратор.
    - Результат: Список всех таблиц.

- **GET /tables/:table_name/elements**
    - Назначение: Получение элементов из указанной таблицы.
    - Авторизация: Требуется JWT токен.
    - Роль: Администратор.
    - Результат: Список элементов из указанной таблицы.

## Контакты

Бот технической поддержки: [@Projects_supportbot](https://t.me/Projects_supportbot)

## Юридическая информация

Регистрационный номер компании: 0835566025199 - DBD

Все права защищены и принадлежат компании Decimal DApps Co Ltd.
